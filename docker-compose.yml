services:
  proxy:
    image: nginx:stable-alpine
    restart: unless-stopped
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    environment:
      HTTP_PORT: 80
      HTTPS_PORT: 443
      SOURCE_PORT: 443
      # Use the Docker service name for the client upstream to avoid DNS resolution failures
      CLIENT_HOST: client
      CLIENT_PORT: 8080
      OIDC_HOST: oidc
      OIDC_PORT: 8080
      CLIENT_DOMAIN: ${CLIENT_DOMAIN:-papermail.local}
      OIDC_DOMAIN: ${OIDC_DOMAIN:-oidc.papermail.local}
    volumes:
      - ./docker/nginx/templates:/etc/nginx/templates:ro
      - ./docker/nginx/snippets:/etc/nginx/snippets:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.crt:/etc/nginx/ssl/cert.pem:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.key:/etc/nginx/ssl/key.pem:ro
    depends_on:
      client:
        condition: service_started
      mail:
        condition: service_started
      oidc:
        condition: service_started
    networks:
      - papermail-net

  client:
    build:
      context: .
      dockerfile: src/PaperMail.Web/Dockerfile
    entrypoint: ["sh","-c","update-ca-certificates && dotnet PaperMail.Web.dll"]
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - IMAP__HOST=mail.papermail.local
      - IMAP__PORT=143
      - IMAP__USESSL=false
      - SMTP__HOST=mail.papermail.local
      - SMTP__PORT=587
      - SMTP__USETLS=true
      - SMTP__USERNAME=admin@papermail.local
      - SMTP__PASSWORD=P@ssw0rd
      - OAUTH__CLIENTID=a92e2069-b509-450b-a9e8-d73cead8735a
      - OAUTH__CLIENTSECRET=YTkyZTIwNjktYjUwOS00NTBiLWE5ZTgtZDczY2VhZDg3MzVh
      - OAUTH__SCOPES__0=openid
      - OAUTH__SCOPES__1=profile
      - OAUTH__SCOPES__2=email
      - OAUTH__SCOPES__3=offline_access
      - OAUTH__REDIRECTURI=https://${CLIENT_DOMAIN:-papermail.local}/oauth/callback
      - OAUTH__AUTHORIZATIONENDPOINT=https://${OIDC_DOMAIN:-oidc.papermail.local}/auth
      - OAUTH__TOKENENDPOINT=http://oidc:8080/token
    volumes:
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.crt:/usr/local/share/ca-certificates/papermail.local.crt:ro
      # Persist DataProtection key ring to survive container restarts
      - clientdata:/app/keys
    depends_on:
      - mail
      - oidc
    restart: unless-stopped
    networks:
      - papermail-net

  mail:
    hostname: mail
    domainname: papermail.local
    image: docker.io/mailserver/docker-mailserver:latest
    environment:
      # Allow access from other containers
      - PERMIT_DOCKER=network
      # Disable SSL requirement for development
      - SSL_TYPE=self-signed
      # Enable OAuth2 authentication
      - ENABLE_OAUTH2=1
      # Point to your OAuth provider's introspection endpoint
      - OAUTH2_INTROSPECTION_URL=http://oidc:8080/token/introspection
      - OAUTH2_INTROSPECTION_MODE=post
      - OAUTH2_CLIENT_ID=a92e2069-b509-450b-a9e8-d73cead8735a
      - OAUTH2_CLIENT_SECRET=YTkyZTIwNjktYjUwOS00NTBiLWE5ZTgtZDczY2VhZDg3MzVh
      - OAUTH2_USERNAME_ATTRIBUTE=email
      # Define users with OAuth. They don't need a password defined in docker-mailserver.
      - DMS_AUTH_OAUTH2_ACCOUNTS=admin@papermail.local,user@papermail.local
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "993:993"
    volumes:
      - maildata:/var/mail
      - mailstate:/var/mail-state
      - maillogs:/var/log/mail
      - ./docker/mailserver/config/:/tmp/docker-mailserver/
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.key:/tmp/docker-mailserver/ssl/mail.papermail.local-key.pem:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.crt:/tmp/docker-mailserver/ssl/mail.papermail.local-cert.pem:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.crt:/tmp/docker-mailserver/ssl/demoCA/cacert.pem:ro
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    restart: unless-stopped
    networks:
      papermail-net:
        aliases:
          - mail.papermail.local

  oidc:
    build:
      context: .
      dockerfile: src/PaperMail.Oidc/Dockerfile
    environment:
      - PORT=8080
      - ISSUER=http://oidc:8080
      - EXTERNAL_HOST_NAME=${OIDC_DOMAIN:-oidc.papermail.local}
      - CLIENT_ID=${OIDC_CLIENT_ID:-a92e2069-b509-450b-a9e8-d73cead8735a}
      - CLIENT_SECRET=${OIDC_CLIENT_SECRET:-YTkyZTIwNjktYjUwOS00NTBiLWE5ZTgtZDczY2VhZDg3MzVh}
      - REDIRECT_URIS=https://${CLIENT_DOMAIN:-papermail.local}/oauth/callback
      - POST_LOGOUT_REDIRECT_URIS=https://${CLIENT_DOMAIN:-papermail.local}/auth/logout/callback
      - COOKIE_KEYS=${OIDC_COOKIE_KEYS:-59761AB67FB5BA23BDD917B2F2E409394A848F50FA9CEB08860C73495339266E}
      # Optional: Override default users by providing JSON array
      # - USERS=[{"id":"945dc90b-02ac-43e5-a4ab-2db744dce149","email":"admin@papermail.local","email_verified":true,"name":"Administrator Account","nickname":"admin","given_name":"Administrator","family_name":"Account","password":"P@ssw0rd","groups":["Everyone","Administrators"]}]
    restart: unless-stopped
    networks:
      - papermail-net

volumes:
  clientdata:
  maildata:
  mailstate:
  maillogs:

networks:
  papermail-net:
    driver: bridge
