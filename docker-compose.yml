services:
  proxy:
    image: nginx:stable-alpine
    restart: unless-stopped
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    environment:
      HTTP_PORT: 80
      HTTPS_PORT: 443
      SOURCE_PORT: 443
      # Use the Docker service name for the client upstream to avoid DNS resolution failures
      CLIENT_HOST: client
      CLIENT_PORT: 8080
      OIDC_HOST: oidc
      OIDC_PORT: 8080
      CLIENT_DOMAIN: ${CLIENT_DOMAIN:-papermail.local}
      OIDC_DOMAIN: ${OIDC_DOMAIN:-oidc.papermail.local}
    volumes:
      - ./docker/nginx/templates:/etc/nginx/templates:ro
      - ./docker/nginx/snippets:/etc/nginx/snippets:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.crt:/etc/nginx/ssl/cert.pem:ro
      - ${CERTIFICATE_PATH:-~/.aspnet/https}/papermail.local.key:/etc/nginx/ssl/key.pem:ro
    depends_on:
      client:
        condition: service_started
      mail:
        condition: service_started
      oidc:
        condition: service_started
    networks:
      - papermail-net

  client:
    build:
      context: .
      dockerfile: src/PaperMail.Web/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - IMAP__HOST=mail
      - IMAP__PORT=993
      - IMAP__USESSL=true
      - SMTP__HOST=mail
      - SMTP__PORT=587
      - SMTP__USETLS=true
      - OAUTH__CLIENTID=a92e2069-b509-450b-a9e8-d73cead8735a
      - OAUTH__CLIENTSECRET=YTkyZTIwNjktYjUwOS00NTBiLWE5ZTgtZDczY2VhZDg3MzVh
      - OAUTH__SCOPES__0=openid
      - OAUTH__SCOPES__1=profile
      - OAUTH__SCOPES__2=email
      - OAUTH__REDIRECTURI=https://${CLIENT_DOMAIN:-papermail.local}/oauth/callback
      - OAUTH__AUTHORIZATIONENDPOINT=https://${OIDC_DOMAIN:-oidc.papermail.local}/auth
      - OAUTH__TOKENENDPOINT=http://oidc:8080/token
    depends_on:
      - mail
      - oidc
    restart: unless-stopped
    networks:
      - papermail-net

  mail:
    image: docker.io/mailserver/docker-mailserver:latest
    environment:
      # Enable OAuth2 authentication
      - ENABLE_OAUTH2=1
      # Point to your OAuth provider's introspection endpoint
      - OAUTH2_INTROSPECTION_URL=https://${OIDC_DOMAIN:-oidc.papermail.local}/token/introspection
      # Define users with OAuth. They don't need a password defined in docker-mailserver.
      - DMS_AUTH_OAUTH2_ACCOUNTS=user1@papermail.local,user2@papermail.local
      # (Optional) Allow access from other containers
      - PERMIT_DOCKER=network
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "993:993"
    volumes:
      - maildata:/var/mail
      - mailstate:/var/mail-state
      - maillogs:/var/log/mail
      - ./docker/mailserver/config/:/tmp/docker-mailserver/
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    restart: unless-stopped
    networks:
      - papermail-net

  oidc:
    image: qlik/simple-oidc-provider:latest
    environment:
      - IDP_NAME=http://oidc:8080
      - EXTERNAL_HOST_NAME=${OIDC_DOMAIN:-oidc.papermail.local}
      - PORT=8080
      - REDIRECTS=https://${CLIENT_DOMAIN:-papermail.local}/oauth/callback
      - POST_LOGOUT_REDIRECTS=https://${CLIENT_DOMAIN:-papermail.local}/auth/logout/callback
      - CONFIG_FILE=/mnt/config/config.json
      - USERS_FILE=/mnt/config/users.json
    volumes:
      - ./docker/oidc/:/mnt/config/:ro
    restart: unless-stopped
    networks:
      - papermail-net

volumes:
  maildata:
  mailstate:
  maillogs:

networks:
  papermail-net:
    driver: bridge
